# 카프카 기초 다지기

## 주요 요소

- 주키퍼(Zookeeper): 아파치 프로젝트 애플리케이션 이름이다. 카프카의 메타데이터(metadata) 관리 및 브로커의 정상상태 점검을 담당한다. 
- 카프카(Kafka) 또는 카프카 클러스터(Kafka cluster): 아파치 프로젝트 애플리케이션 이름이다. 여러 대의 브로커를 구성한 클러스터를 의미한다. 
- 브로커(broker): 카프카 애플리케이션이 설치된 서버 또는 노드를 말한다. 
- 프로듀서(producer): 카프카로 메시지를 보내는 역할을 하는 클라이언트를 총칭한다. 
- 컨슈머(consumer): 카프카에서 메시지를 꺼내가는 역할을 하는 클라이언트를 총칭한다. 
- 토픽(topic): 카프카는 메시지 피드들을 토픽으로 구분하고, 각 토픽의 이름은 카프카 내에서 고유하다. 
- 세그먼트(segment): 프로듀서가 전송한 실제 메시지가 브로커의 <mark style="background: #D2B3FFA6;">로컬 디스크에 저장되는 파일</mark>을 말한다 .
- 메시지(message) 또는 레코드(record): <mark style="background: #D2B3FFA6;">프로듀서가 브로커로 전송하거나 컨슈머가 읽어가는 데이터 조각</mark>을 말한다 .



## 리플리케이션 (replication)

> 리플리케이션이란 각 메시지들을 여러 개로 복제해서 카프카 클러스터 내 브로커들에 분산시키는 동작을 의미한다. 리플리케이션 동작으로 인해 하나의 브로커가 종료되더라도 카프카는 안정성을 유지할 수 있다. 

모든 토픽에 대해 각 3개의 리플리케이션으로 설정할 수 있다. 리플리케이션 팩터 수가 높을 수록 안정성은 높아지지만 그만큼 브로커 리소스를 많이 사용하게 됨
<mark style="background: #D2B3FFA6;">복제에 대한 오버헤드를 줄여서 최대한 브로커를 효율적으로 사용하는 것을 권장</mark>


![[Pasted image 20231029221038.png]]


## 파티션 (partition)

하나의 토픽이 한 번에 처리할 수 있는 한계를 높이기 위해 토픽 하나를 여러 개로 나눠 병렬 처리가 가능하게 만든 것을 파티션이라고 한다. 


![[Pasted image 20231029221206.png]]


####  한 번 늘린 파티션 수는 절대로 줄일 수 없다. 2 or 4 정도로 생성한 후 메시지 처리량 또는 컨슈머의 LAG 등을 모니터링하면서 조금씩 늘려가라.

> <mark style="background: #D2B3FFA6;">컨슈머의 LAG이란 ‘프로듀서가 보낸 메시지 수(카프카에 남아 있는 메시지 수) – 컨슈머가 가져간 메시지 수’</mark> 를 나타냅니다. 예를 들어, 프로듀서가 5개의 메시지를 카프카로 전송했는데 컨슈머는 4개 의 메시지만 가져갔다면 컨슈머 LAG은 5 - 4 = 1입니다. 컨슈머가 지연 없이 모든 메시지를 가져갔다면 5 - 5 = 0입니다. 따라서 LAG이라는 지표를 통해 컨슈머에 지연이 없는지 확인 할 수 있습니다.


## 세그먼트
> 카프카는 각 메시지들을 저장한다. 토픽의 파티션에 저장되며 각 메시지들은 세그먼트라는 로그 파일의 형태로 브로커의 로컬 디스크에 저장된다. 



![[Pasted image 20231029221956.png]]



```bash
cd /data/kafka-logs/
cd peter-overview01-0
xxd 00000000000000000000.log # 로그 hexdump
```


# 컨슈머

실제로 토픽에는 메시지가 존재하지만 잘못된 오프셋 커밋으로 인한 위치 변경으로 컨슈머가 메시지를 가져오지 못하는 경우를 말한다. 
메시지가 손실되면 안 되는 중요한 처리 작업들은 동기 방식으로 진행해라
하지만 이도 메시지 중복 이슈는 피할 수 없다. 


